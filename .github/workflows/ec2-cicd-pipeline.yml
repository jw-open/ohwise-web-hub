name: Build Docker Image and Deploy to EC2

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  id-token: write

env:
  IMAGE_NAME: liveget/ohwise-web-hub
  K8S_NAMESPACE: ohwise
  K8S_DEPLOYMENT: ohwise-web-hub
  K8S_CONTAINER: ohwise-web-hub
  AWS_REGION: us-east-1

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Build the Docker image
      id: build
      run: |
        TAG=$(date +%s)
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "Building image: $IMAGE_NAME:$TAG"
        docker build -t $IMAGE_NAME:$TAG .

    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Push Docker image
      run: |
          docker push $IMAGE_NAME:$TAG

    # optional: Redeploy via AWS SSM
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}


    - name: Trigger rollout via SSM (instrumented)
      run: |
        set -euo pipefail

          # Script that runs on the EC2 instance via SSM
          REMOTE_SCRIPT=$(cat <<'EOS'
          set -euo pipefail
          export HOME=/root
          export KUBECONFIG=/root/.kube/config
          export PATH="$PATH:/usr/local/bin:/usr/bin:/bin:/snap/bin"

          echo "== whoami: $(whoami)"
          echo "== HOME: $HOME"
          echo "== KUBECONFIG: $KUBECONFIG"
          echo "== kubectl path: $(command -v kubectl || true)"
          kubectl version --client=true || true

          echo "== current context:"
          kubectl config current-context || true
          kubectl config view --minify | sed -n 's/ *server: */server: /p' || true

          echo "== precheck: deployment image BEFORE"
          kubectl -n "$K8S_NAMESPACE" get deploy "$K8S_DEPLOYMENT" -o jsonpath='{.spec.template.spec.containers[?(@.name=="'"$K8S_CONTAINER"'")].image}'; echo

          echo "== set image to: $IMAGE_NAME:$TAG"
          kubectl -n "$K8S_NAMESPACE" set image deployment/"$K8S_DEPLOYMENT" "$K8S_CONTAINER"="$IMAGE_NAME:$TAG" --record

          echo "== rollout status"
          kubectl -n "$K8S_NAMESPACE" rollout status deployment/"$K8S_DEPLOYMENT" --timeout=300s

          echo "== postcheck: deployment image AFTER"
          kubectl -n "$K8S_NAMESPACE" get deploy "$K8S_DEPLOYMENT" -o jsonpath='{.spec.template.spec.containers[?(@.name=="'"$K8S_CONTAINER"'")].image}'; echo

          echo "== pods + images"
          kubectl -n "$K8S_NAMESPACE" get pods -l app="$K8S_DEPLOYMENT" -o=custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[*].image --no-headers

          echo "== rollout history"
          kubectl -n "$K8S_NAMESPACE" rollout history deployment/"$K8S_DEPLOYMENT" || true

          echo "== rbac can-i check"
          kubectl -n "$K8S_NAMESPACE" auth can-i update deployment/"$K8S_DEPLOYMENT" || true
          EOS
          )

              # Send the command and capture CommandId
              CMD_ID=$(aws ssm send-command \
                --instance-ids "${{ secrets.SSM_INSTANCE_ID }}" \
                --document-name "AWS-RunShellScript" \
                --parameters commands="$REMOTE_SCRIPT",executionTimeout="600" \
                --query "Command.CommandId" --output text)

              echo "SSM CommandId: $CMD_ID"

              # Wait until it finishes
              while true; do
                STATUS=$(aws ssm get-command-invocation \
                  --command-id "$CMD_ID" \
                  --instance-id "${{ secrets.SSM_INSTANCE_ID }}" \
                  --query "Status" --output text)
                echo "SSM status: $STATUS"
                [[ "$STATUS" == "InProgress" || "$STATUS" == "Pending" || "$STATUS" == "Delayed" ]] || break
                sleep 3
              done

              echo "----- STDOUT -----"
              aws ssm get-command-invocation \
                --command-id "$CMD_ID" \
                --instance-id "${{ secrets.SSM_INSTANCE_ID }}" \
                --query "StandardOutputContent" --output text || true

              echo "----- STDERR -----"
              aws ssm get-command-invocation \
                --command-id "$CMD_ID" \
                --instance-id "${{ secrets.SSM_INSTANCE_ID }}" \
                --query "StandardErrorContent" --output text || true

              # Fail the step if SSM reported non-success
              FINAL=$(aws ssm get-command-invocation \
                --command-id "$CMD_ID" \
                --instance-id "${{ secrets.SSM_INSTANCE_ID }}" \
                --query "Status" --output text)
              test "$FINAL" = "Success"
