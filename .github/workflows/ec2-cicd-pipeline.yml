name: Build Docker Image and Deploy to EC2

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  id-token: write

env:
  IMAGE_NAME: liveget/ohwise-web-hub
  K8S_NAMESPACE: ohwise
  K8S_DEPLOYMENT: ohwise-web-hub
  K8S_CONTAINER: ohwise-web-hub
  AWS_REGION: us-east-1

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Build the Docker image
      id: build
      run: |
        TAG=$(date +%s)
        echo "TAG=$TAG" >> $GITHUB_ENV
        echo "Building image: $IMAGE_NAME:$TAG"
        docker build -t $IMAGE_NAME:$TAG .

    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: Push Docker image
      run: |
          docker push $IMAGE_NAME:$TAG

    # optional: Redeploy via AWS SSM
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}


    - name: Trigger rollout via SSM (script file)
      run: |
        set -euo pipefail

        # Create a small script the instance will run
        cat > remote.sh <<'BASH'
        set -euo pipefail
        export HOME=/root
        export KUBECONFIG=/root/.kube/config
        export PATH=/usr/local/bin:/usr/bin:/bin:/snap/bin:$PATH

        echo "whoami: $(whoami)"
        kubectl config current-context || true
        kubectl -n __NS__ get deploy __DEPLOY__ -o jsonpath='{.spec.template.spec.containers[?(@.name=="__CONTAINER__")].image}'; echo

        kubectl -n __NS__ set image deployment/__DEPLOY__ __CONTAINER__="__IMAGE__:__TAG__" --record
        kubectl -n __NS__ rollout status deployment/__DEPLOY__ --timeout=300s

        kubectl -n __NS__ get deploy __DEPLOY__ -o jsonpath='{.spec.template.spec.containers[?(@.name=="__CONTAINER__")].image}'; echo
        kubectl -n __NS__ get pods -l app=__DEPLOY__ -o=custom-columns=NAME:.metadata.name,IMAGE:.spec.containers[*].image --no-headers || true
        BASH

        # Substitute placeholders with your env values (safe literal replace)
        sed -i "s#__NS__#${K8S_NAMESPACE}#g" remote.sh
        sed -i "s#__DEPLOY__#${K8S_DEPLOYMENT}#g" remote.sh
        sed -i "s#__CONTAINER__#${K8S_CONTAINER}#g" remote.sh
        sed -i "s#__IMAGE__#${IMAGE_NAME}#g" remote.sh
        sed -i "s#__TAG__#${TAG}#g" remote.sh

        # Upload as the commands parameter (array with a single bash -lc invocation)
        aws ssm send-command \
          --instance-ids "${{ secrets.SSM_INSTANCE_ID }}" \
          --document-name "AWS-RunShellScript" \
          --parameters commands="$(printf '%q' "bash -lc 'cat > /tmp/rollout.sh <<\"EOF\" && chmod +x /tmp/rollout.sh && /tmp/rollout.sh
            $(cat remote.sh)
            EOF
            '")" \
          --output text

